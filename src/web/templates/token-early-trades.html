<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£å¸æœ€æ—©äº¤æ˜“ - Richer-js</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="/static/css/light-theme.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top-color: #10b981;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .tab-container {
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            overflow: hidden;
            background: white;
        }
        .tab-header {
            display: flex;
            background: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
        }
        .tab-button {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        .tab-button:hover {
            color: #374151;
            background: #e5e7eb;
        }
        .tab-button.active {
            color: #2563eb;
            background: white;
            border-bottom-color: #2563eb;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        .data-table th {
            position: sticky;
            top: 0;
            background: #f9fafb;
            padding: 0.5rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        .data-table td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            color: #1f2937;
        }
        .data-table tr:hover {
            background: #f9fafb;
        }
        .monospace {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-size: 0.75rem;
        }
        .text-green { color: #10b981; }
        .text-red { color: #ef4444; }
        .empty-state {
            padding: 2rem;
            text-align: center;
            color: #9ca3af;
        }
        .info-card {
            background: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            color: #6b7280;
            font-size: 0.875rem;
        }
        .info-value {
            color: #1f2937;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .action-btn {
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 2px;
        }
        .action-btn:hover {
            opacity: 0.8;
        }
        .btn-good-holder {
            background: #10b981;
            color: white;
        }
        .btn-pump-group {
            background: #f97316;
            color: white;
        }
        .btn-delete {
            background: #ef4444;
            color: white;
        }
        .gmgn-link {
            color: #3b82f6;
            text-decoration: none;
            font-size: 11px;
            margin-left: 4px;
        }
        .gmgn-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-6xl">
        <!-- é¡µå¤´ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">å†…ç›˜ä»£å¸æœ€æ—©äº¤æ˜“</h1>
                    <p class="text-gray-600 mt-2">æŸ¥è¯¢ä»£å¸åˆ›å»ºåçš„æœ€æ—©äº¤æ˜“è®°å½•</p>
                </div>
                <a href="/experiments" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">
                    â† è¿”å›
                </a>
            </div>
        </div>

        <!-- æŸ¥è¯¢è¡¨å• -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">ä»£å¸ä¿¡æ¯</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ä»£å¸åœ°å€</label>
                    <input type="text" id="tokenAddress" placeholder="0x..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åŒºå—é“¾</label>
                    <select id="chain" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="bsc">BSC</option>
                        <option value="eth">ETH</option>
                        <option value="solana">Solana</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="queryTokenEarlyTrades()"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                        ğŸ” æŸ¥è¯¢
                    </button>
                </div>
            </div>
            <div id="queryStatus" class="hidden mt-4"></div>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒº -->
        <div id="resultContainer" class="hidden">
            <!-- ä»£å¸ä¿¡æ¯ TAB -->
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="tab-container">
                    <div class="tab-header">
                        <button class="tab-button active" onclick="switchTab('info')">ğŸ“Š ä»£å¸ä¿¡æ¯</button>
                        <button class="tab-button" onclick="switchTab('trades')">ğŸ“ˆ æœ€æ—©äº¤æ˜“</button>
                    </div>

                    <!-- ä»£å¸ä¿¡æ¯å†…å®¹ -->
                    <div id="tabInfo" class="tab-content active p-6">
                        <div id="tokenInfoContent"></div>
                    </div>

                    <!-- æœ€æ—©äº¤æ˜“å†…å®¹ -->
                    <div id="tabTrades" class="tab-content p-6">
                        <div id="tradesContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTokenInfo = null;
        let currentEarlyTrades = [];
        let walletBlacklist = new Set(); // å­˜å‚¨é»‘åå•é’±åŒ…åœ°å€
        let walletWhitelist = new Set(); // å­˜å‚¨ç™½åå•é’±åŒ…åœ°å€

        // TAB åˆ‡æ¢
        function switchTab(tab) {
            const buttons = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');

            buttons.forEach(btn => btn.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));

            if (tab === 'info') {
                buttons[0].classList.add('active');
                document.getElementById('tabInfo').classList.add('active');
            } else {
                buttons[1].classList.add('active');
                document.getElementById('tabTrades').classList.add('active');
            }
        }

        // è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
        function toBeijingTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp * 1000);
            const beijingTime = new Date(date.getTime() + 8 * 60 * 60 * 1000);
            return beijingTime.toISOString().replace('T', ' ').replace(/\.\d+Z$/, '').substring(0, 19);
        }

        // æ¸²æŸ“ä»£å¸ä¿¡æ¯
        function renderTokenInfo(tokenInfo) {
            const { token, pairs, is_audited } = tokenInfo;
            const container = document.getElementById('tokenInfoContent');

            // æŸ¥æ‰¾ main_pair
            const mainPair = token.main_pair || (pairs.length > 0 ? pairs[0].pair : '-');

            // ä»·æ ¼å˜åŒ–é¢œè‰²
            const priceChange24h = parseFloat(token.price_change_24h || 0);
            const priceChangeClass = priceChange24h >= 0 ? 'text-green' : 'text-red';

            const html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- åŸºæœ¬ä¿¡æ¯ -->
                    <div class="info-card">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">åŸºæœ¬ä¿¡æ¯</h3>
                        <div class="info-row">
                            <span class="info-label">ä»£å¸ç¬¦å·</span>
                            <span class="info-value">${token.symbol || '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ä»£å¸åç§°</span>
                            <span class="info-value">${token.name || '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ä»£å¸åœ°å€</span>
                            <span class="info-value monospace">${token.token || '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">åŒºå—é“¾</span>
                            <span class="info-value">${token.chain || '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">åˆ›å»ºæ—¶é—´</span>
                            <span class="info-value">${toBeijingTime(token.created_at)}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ä¸Šæ¶æ—¶é—´</span>
                            <span class="info-value">${toBeijingTime(token.launch_at)}</span>
                        </div>
                    </div>

                    <!-- ä»·æ ¼ä¿¡æ¯ -->
                    <div class="info-card">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">ä»·æ ¼ä¿¡æ¯</h3>
                        <div class="info-row">
                            <span class="info-label">å½“å‰ä»·æ ¼ (USD)</span>
                            <span class="info-value">$${parseFloat(token.current_price_usd || 0).toFixed(6)}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">24hæ¶¨è·Œ</span>
                            <span class="info-value ${priceChangeClass}">${priceChange24h}%</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å¸‚å€¼</span>
                            <span class="info-value">$${parseFloat(token.market_cap || 0).toLocaleString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">FDV</span>
                            <span class="info-value">$${parseFloat(token.fdv || 0).toLocaleString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">TVL</span>
                            <span class="info-value">$${parseFloat(token.tvl || 0).toLocaleString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æŒæœ‰è€…æ•°</span>
                            <span class="info-value">${token.holders || 0}</span>
                        </div>
                    </div>

                    <!-- äº¤æ˜“å¯¹ä¿¡æ¯ -->
                    <div class="info-card">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">äº¤æ˜“å¯¹ä¿¡æ¯</h3>
                        <div class="info-row">
                            <span class="info-label">Main Pair</span>
                            <span class="info-value monospace">${mainPair}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">äº¤æ˜“å¯¹æ•°é‡</span>
                            <span class="info-value">${pairs.length}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å·²å®¡è®¡</span>
                            <span class="info-value">${is_audited ? 'æ˜¯' : 'å¦'}</span>
                        </div>
                    </div>

                    <!-- å…¶ä»–ä¿¡æ¯ -->
                    <div class="info-card">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">å…¶ä»–ä¿¡æ¯</h3>
                        <div class="info-row">
                            <span class="info-label">æ€»ä¾›åº”é‡</span>
                            <span class="info-value">${parseFloat(token.total || 0).toLocaleString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">é”å®šæ¯”ä¾‹</span>
                            <span class="info-value">${token.locked_percent || '-'}%</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">24häº¤æ˜“é‡</span>
                            <span class="info-value">$${parseFloat(token.tx_volume_u_24h || 0).toLocaleString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">é£é™©ç­‰çº§</span>
                            <span class="info-value">${token.risk_level || '-'}</span>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // æ¸²æŸ“æœ€æ—©äº¤æ˜“
        function renderEarlyTrades(trades, debugInfo) {
            const container = document.getElementById('tradesContent');

            if (!trades || trades.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— äº¤æ˜“è®°å½•</div>';
                return;
            }

            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            let debugHtml = '';
            if (debugInfo) {
                const launchAtStr = debugInfo.launchAt ? toBeijingTime(debugInfo.launchAt) : '-';
                const createdAtStr = debugInfo.createdAt ? toBeijingTime(debugInfo.createdAt) : '-';
                const firstTradeStr = debugInfo.firstTradeTime ? toBeijingTime(debugInfo.firstTradeTime) : '-';
                const lastTradeStr = debugInfo.lastTradeTime ? toBeijingTime(debugInfo.lastTradeTime) : '-';

                debugHtml = `
                    <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded text-sm">
                        <div class="font-semibold text-yellow-800 mb-3">âš ï¸ æ•°æ®èŒƒå›´è¯´æ˜</div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 mb-3">
                            <div>launch_at: <span class="font-medium">${launchAtStr}</span></div>
                            <div>created_at: <span class="font-medium">${createdAtStr}</span></div>
                            <div>pairId: <span class="monospace font-medium">${debugInfo.pairId || '-'}</span></div>
                            <div>æ€»äº¤æ˜“æ•°: <span class="font-medium">${debugInfo.totalTrades || 0}</span></div>
                            <div class="${debugInfo.firstTradeTime && debugInfo.firstTradeTime > (debugInfo.launchAt || 0) ? 'text-red-600 font-semibold' : ''}">æœ€æ—©äº¤æ˜“: <span class="font-medium">${firstTradeStr}</span></div>
                            <div>æœ€æ™šäº¤æ˜“: <span class="font-medium">${lastTradeStr}</span></div>
                        </div>
                        ${debugInfo.firstTradeTime && debugInfo.firstTradeTime > (debugInfo.launchAt || 0) ?
                            '<div class="mt-2 p-2 bg-red-100 rounded text-red-800">âš ï¸ API è¿”å›çš„æœ€æ—©äº¤æ˜“æ™šäºä»£å¸åˆ›å»ºæ—¶é—´ï¼Œè¯´æ˜ AVE API åªä¿ç•™æœ€è¿‘ä¸€æ®µæ—¶é—´çš„æ•°æ®</div>' : ''}
                    </div>

                    <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded text-sm">
                        <div class="font-semibold text-gray-800 mb-2">ğŸ”§ getSwapTransactions å‚æ•°</div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-gray-800">
                            <div>pairId: <span class="monospace font-medium">${debugInfo.apiParams?.pairId || '-'}</span></div>
                            <div>limit: <span class="font-medium">${debugInfo.apiParams?.limit || '-'}</span></div>
                            <div>fromTime: <span class="font-medium">${debugInfo.apiParams?.fromTimeFormatted || 'null'}</span></div>
                            <div>toTime: <span class="font-medium">${debugInfo.apiParams?.toTimeFormatted || 'null'}</span></div>
                            <div>sort: <span class="font-medium">${debugInfo.apiParams?.sort || '-'}</span></div>
                        </div>
                        <div class="mt-2 text-gray-800 text-xs">
                            ğŸ’¡ fromTime: ä»£å¸ launch_atï¼ŒtoTime: launch_at + 10åˆ†é’Ÿï¼Œè·å–ä»£å¸åˆ›å»ºå10åˆ†é’Ÿå†…çš„äº¤æ˜“
                        </div>
                    </div>
                `;
            }

            const html = `
                ${debugHtml}
                <div class="mb-4 text-sm text-gray-600">
                    æ˜¾ç¤º ${trades.length} æ¡äº¤æ˜“è®°å½•ï¼ˆæŒ‰æ—¶é—´å‡åºï¼‰
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ—¶é—´ (åŒ—äº¬)</th>
                                <th>äº¤æ˜“ID</th>
                                <th>ä¹°å…¥é’±åŒ…</th>
                                <th>å–å‡ºé’±åŒ…</th>
                                <th>from</th>
                                <th>fromæ•°é‡</th>
                                <th>to</th>
                                <th>toæ•°é‡</th>
                                <th>USDä»·å€¼</th>
                                <th>åŒºå—</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${trades.map(tx => renderTradeRow(tx)).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // æ¸²æŸ“å•è¡Œäº¤æ˜“
        function renderTradeRow(tx) {
            const fromAddr = tx.from_address || '';
            const toAddr = tx.to_address || '';

            // åˆ¤æ–­é’±åŒ…æ˜¯å¦åœ¨é»‘åå•/ç™½åå•ä¸­
            const fromInBlacklist = walletBlacklist.has(fromAddr.toLowerCase());
            const fromInWhitelist = walletWhitelist.has(fromAddr.toLowerCase());
            const toInBlacklist = walletBlacklist.has(toAddr.toLowerCase());
            const toInWhitelist = walletWhitelist.has(toAddr.toLowerCase());

            // ç”Ÿæˆåœ°å€çŸ­ç 
            const fromShort = fromAddr ? `${fromAddr.substring(0, 8)}...` : '-';
            const toShort = toAddr ? `${toAddr.substring(0, 8)}...` : '-';

            return `
                <tr>
                    <td>${toBeijingTime(tx.time)}</td>
                    <td class="monospace" title="${tx.tx_id}">${tx.tx_id.substring(0, 10)}...</td>
                    <td class="monospace" title="${fromAddr}">
                        ${fromShort}
                        <a href="https://gmgn.ai/bsc/address/${fromAddr}" target="_blank" class="gmgn-link" title="åœ¨ GMGN æŸ¥çœ‹">GMGN</a>
                        ${fromAddr ? renderWalletActions(fromAddr, fromInBlacklist, fromInWhitelist) : ''}
                    </td>
                    <td class="monospace" title="${toAddr}">
                        ${toShort}
                        <a href="https://gmgn.ai/bsc/address/${toAddr}" target="_blank" class="gmgn-link" title="åœ¨ GMGN æŸ¥çœ‹">GMGN</a>
                        ${toAddr ? renderWalletActions(toAddr, toInBlacklist, toInWhitelist) : ''}
                    </td>
                    <td>${tx.from_token_symbol || '-'}</td>
                    <td>${tx.from_amount ? tx.from_amount.toFixed(6) : '-'}</td>
                    <td>${tx.to_token_symbol || '-'}</td>
                    <td>${tx.to_amount ? tx.to_amount.toFixed(6) : '-'}</td>
                    <td>${tx.from_usd ? '$' + tx.from_usd.toFixed(2) : '-'}</td>
                    <td>${tx.block_number || '-'}</td>
                </tr>
            `;
        }

        // æ¸²æŸ“é’±åŒ…æ“ä½œæŒ‰é’®
        function renderWalletActions(address, inBlacklist, inWhitelist) {
            if (inWhitelist) {
                return `<button class="action-btn btn-delete" onclick="deleteWallet('${address}')" title="ä»ç™½åå•åˆ é™¤">âš¡ å–æ¶ˆ</button>`;
            } else if (inBlacklist) {
                return `<button class="action-btn btn-delete" onclick="deleteWallet('${address}')" title="ä»é»‘åå•åˆ é™¤">ğŸ—‘ï¸</button>`;
            } else {
                return `
                    <button class="action-btn btn-good-holder" onclick="addGoodHolder('${address}')" title="æ ‡è®°ä¸ºå¥½æŒæœ‰è€…">âœ¨</button>
                    <button class="action-btn btn-pump-group" onclick="addPumpGroup('${address}')" title="æ·»åŠ åˆ°æµæ°´ç›˜é»‘åå•">âš ï¸</button>
                `;
            }
        }

        // æ·»åŠ åˆ°å¥½æŒæœ‰è€…ç™½åå•
        async function addGoodHolder(address) {
            try {
                const confirmed = confirm(
                    `âœ¨ ç¡®å®šè¦å°†æ­¤é’±åŒ…æ ‡è®°ä¸ºå¥½æŒæœ‰è€…å—ï¼Ÿ\n\n` +
                    `åœ°å€: ${address}\n` +
                    `åˆ†ç±»: good_holder\n\n` +
                    `æ³¨æ„ï¼šç™½åå•é’±åŒ…å°†è·³è¿‡é»‘åå•æ£€æµ‹ã€‚`
                );

                if (!confirmed) return;

                const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const walletName = `å¥½æŒæœ‰è€…-${dateStr}`;

                const response = await fetch('/api/wallets/add-single', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address: address,
                        name: walletName,
                        category: 'good_holder'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    if (result.alreadyExists) {
                        alert(`â„¹ï¸ ${result.message}`);
                    } else {
                        alert(`âœ… ${result.message}`);
                        walletWhitelist.add(address.toLowerCase());
                        // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                        renderEarlyTrades(currentEarlyTrades, null);
                    }
                } else {
                    alert(`âŒ æ·»åŠ å¤±è´¥: ${result.error}`);
                }
            } catch (error) {
                console.error('æ·»åŠ å¥½æŒæœ‰è€…å¤±è´¥:', error);
                alert(`âŒ æ·»åŠ å¤±è´¥: ${error.message}`);
            }
        }

        // æ·»åŠ åˆ°æµæ°´ç›˜é»‘åå•
        async function addPumpGroup(address) {
            try {
                const confirmed = confirm(
                    `âš ï¸ ç¡®å®šè¦å°†æ­¤é’±åŒ…æ·»åŠ åˆ°æµæ°´ç›˜é»‘åå•å—ï¼Ÿ\n\n` +
                    `åœ°å€: ${address}\n` +
                    `åˆ†ç±»: pump_group`
                );

                if (!confirmed) return;

                const response = await fetch('/api/wallets/add-single', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address: address,
                        name: 'æµæ°´ç›˜é’±åŒ…',
                        category: 'pump_group'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    if (result.alreadyExists) {
                        alert(`â„¹ï¸ ${result.message}`);
                    } else {
                        alert(`âœ… ${result.message}`);
                        walletBlacklist.add(address.toLowerCase());
                        // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                        renderEarlyTrades(currentEarlyTrades, null);
                    }
                } else {
                    alert(`âŒ æ·»åŠ å¤±è´¥: ${result.error}`);
                }
            } catch (error) {
                console.error('æ·»åŠ æµæ°´ç›˜é’±åŒ…å¤±è´¥:', error);
                alert(`âŒ æ·»åŠ å¤±è´¥: ${error.message}`);
            }
        }

        // åˆ é™¤é’±åŒ…
        async function deleteWallet(address) {
            try {
                const confirmed = confirm(
                    `ğŸ—‘ï¸ ç¡®å®šè¦å°†æ­¤é’±åŒ…ä»åå•ä¸­åˆ é™¤å—ï¼Ÿ\n\n` +
                    `åœ°å€: ${address}\n\n` +
                    `æ³¨æ„ï¼šåˆ é™¤åè¯¥é’±åŒ…å°†ä¸å†è¢«è¯†åˆ«ä¸ºé»‘åå•/ç™½åå•é’±åŒ…ã€‚`
                );

                if (!confirmed) return;

                const response = await fetch(`/api/wallets/address/${encodeURIComponent(address)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert(`âœ… ${result.message}`);
                    // ä»æœ¬åœ°ç¼“å­˜ä¸­ç§»é™¤
                    walletBlacklist.delete(address.toLowerCase());
                    walletWhitelist.delete(address.toLowerCase());
                    // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                    renderEarlyTrades(currentEarlyTrades, null);
                } else {
                    alert(`âŒ åˆ é™¤å¤±è´¥: ${result.error}`);
                }
            } catch (error) {
                console.error('åˆ é™¤é’±åŒ…å¤±è´¥:', error);
                alert(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            const status = document.getElementById('queryStatus');
            status.className = 'mt-4 text-center';
            status.innerHTML = '<span class="loading"></span> æŸ¥è¯¢ä¸­...';
            status.classList.remove('hidden');
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const status = document.getElementById('queryStatus');
            status.className = 'mt-4 bg-red-50 border border-red-200 rounded-lg p-4 text-red-800';
            status.textContent = 'âŒ ' + message;
            status.classList.remove('hidden');
        }

        // åŠ è½½é’±åŒ…é»‘åå•/ç™½åå•
        async function loadWalletLists() {
            try {
                const response = await fetch('/api/wallets');
                const result = await response.json();

                if (result.success) {
                    // æ¸…ç©ºç°æœ‰åˆ—è¡¨
                    walletBlacklist.clear();
                    walletWhitelist.clear();

                    // åˆ†ç±»å­˜å‚¨é’±åŒ…åœ°å€
                    result.data.forEach(wallet => {
                        const address = wallet.address.toLowerCase();
                        if (wallet.category === 'good_holder') {
                            walletWhitelist.add(address);
                        } else if (wallet.category === 'pump_group' || wallet.category === 'dev' || wallet.category === 'negative_holder') {
                            walletBlacklist.add(address);
                        }
                    });

                    console.log(`âœ… å·²åŠ è½½é’±åŒ…åˆ—è¡¨: é»‘åå• ${walletBlacklist.size} ä¸ª, ç™½åå• ${walletWhitelist.size} ä¸ª`);
                }
            } catch (error) {
                console.error('åŠ è½½é’±åŒ…åˆ—è¡¨å¤±è´¥:', error);
                // ä¸é˜»æ–­æŸ¥è¯¢æµç¨‹ï¼Œåªæ˜¯æ— æ³•æ˜¾ç¤ºæ­£ç¡®çš„æŒ‰é’®çŠ¶æ€
            }
        }

        // æŸ¥è¯¢ä»£å¸æœ€æ—©äº¤æ˜“
        async function queryTokenEarlyTrades() {
            const tokenAddress = document.getElementById('tokenAddress').value.trim();
            const chain = document.getElementById('chain').value;

            if (!tokenAddress) {
                showError('è¯·è¾“å…¥ä»£å¸åœ°å€');
                return;
            }

            showLoading();
            document.getElementById('resultContainer').classList.add('hidden');

            try {
                // å…ˆåŠ è½½é’±åŒ…é»‘åå•/ç™½åå•
                await loadWalletLists();

                const response = await fetch('/api/token-early-trades', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tokenAddress, chain })
                });

                const result = await response.json();

                if (!result.success) {
                    showError(result.error || 'æŸ¥è¯¢å¤±è´¥');
                    return;
                }

                currentTokenInfo = result.data.tokenInfo;
                currentEarlyTrades = result.data.earlyTrades || [];
                const debugInfo = result.data.debug || null;

                // æ¸²æŸ“ä»£å¸ä¿¡æ¯
                renderTokenInfo(currentTokenInfo);

                // æ¸²æŸ“æœ€æ—©äº¤æ˜“
                renderEarlyTrades(currentEarlyTrades, debugInfo);

                // æ˜¾ç¤ºç»“æœ
                document.getElementById('resultContainer').classList.remove('hidden');
                document.getElementById('queryStatus').classList.add('hidden');

                // é»˜è®¤æ˜¾ç¤ºä»£å¸ä¿¡æ¯ tab
                switchTab('info');

            } catch (error) {
                showError(error.message);
            }
        }
    </script>
</body>
</html>
