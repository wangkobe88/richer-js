<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºå®éªŒ - Richer-js Fourmeme Trading</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="/static/css/light-theme.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="/static/css/main.css" rel="stylesheet">
    <style>
        .hidden { display: none; }
        .error { border-color: #ef4444; }
        .success { border-color: #10b981; }

        /* ç­–ç•¥å¡ç‰‡æ ·å¼ */
        .strategy-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #fafafa;
            transition: all 0.2s;
        }
        .strategy-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .strategy-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .strategy-card .strategy-name {
            font-weight: 600;
            color: #1f2937;
        }
        .strategy-card .btn-remove {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
        }
        .strategy-card .btn-remove:hover {
            background: #dc2626;
        }
        .strategy-card .strategy-params {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        .strategy-card .param-group {
            display: flex;
            flex-direction: column;
        }
        .strategy-card .param-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 0.25rem;
        }
        .strategy-card .param-group input,
        .strategy-card .param-group select {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .strategy-card .param-group .hint {
            font-size: 0.75rem;
            color: #6b7280;
        }

        /* æ¡ä»¶å¸®åŠ©å™¨æ ·å¼ */
        .condition-help {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        .condition-help h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }
        .condition-help .help-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        .condition-help .help-table th,
        .condition-help .help-table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }
        .condition-help .help-table th {
            background: #e5e7eb;
            font-weight: 600;
        }
        .condition-help code {
            background: #1f2937;
            color: #10b981;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .condition-help ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        .condition-help .preset-templates {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .condition-help .preset-templates button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
        }
        .condition-help .preset-templates button:hover {
            background: #2563eb;
        }

        /* åˆå§‹åˆ†é…æ ·å¼ */
        .initial-allocation {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* åŠ¨æ€æ·»åŠ æŒ‰é’® */
        .btn-add {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        .btn-add:hover {
            background: #059669;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-5xl">
        <!-- é¡µå¤´ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">åˆ›å»ºæ–°å®éªŒ</h1>
                    <p class="text-gray-600 mt-2">åŸºäºç­–ç•¥å¡ç‰Œç®¡ç†çš„ fourmeme ä»£å¸äº¤æ˜“å®éªŒ</p>
                </div>
                <a href="/experiments" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">
                    â† è¿”å›åˆ—è¡¨
                </a>
            </div>
        </div>

        <!-- åˆ›å»ºè¡¨å• -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <form id="experiment-form" class="space-y-6">
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">åŸºæœ¬ä¿¡æ¯</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                å®éªŒåç§° <span class="text-red-500">*</span>
                            </label>
                            <input type="text"
                                   name="experiment_name"
                                   required
                                   placeholder="ä¾‹å¦‚ï¼šFourmeme å¡ç‰Œç­–ç•¥äº¤æ˜“å®éªŒ"
                                   value="Fourmeme å¡ç‰Œç­–ç•¥äº¤æ˜“å®éªŒ"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                å®éªŒæè¿°
                            </label>
                            <input type="text"
                                   name="experiment_description"
                                   placeholder="å®éªŒçš„ç®€è¦æè¿°"
                                   value="åŸºäºå¡ç‰Œä»“ä½ç®¡ç†çš„ fourmeme ä»£å¸è‡ªåŠ¨äº¤æ˜“"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                äº¤æ˜“æ¨¡å¼ <span class="text-red-500">*</span>
                            </label>
                            <select name="trading_mode"
                                    required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="virtual" selected>è™šæ‹Ÿäº¤æ˜“</option>
                                <option value="live">å®ç›˜äº¤æ˜“</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                åŒºå—é“¾ <span class="text-red-500">*</span>
                            </label>
                            <select name="blockchain"
                                    required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="bsc" selected>BSC (Binance Smart Chain)</option>
                                <option value="solana">Solana</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                åˆå§‹ä½™é¢ (<span id="native-currency">BNB</span>) <span class="text-red-500">*</span>
                            </label>
                            <input type="number"
                                   name="initial_balance"
                                   id="initial_balance"
                                   required
                                   step="any"
                                   min="0.001"
                                   value="100"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- å¡ç‰Œä»“ä½ç®¡ç†é…ç½® -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">ğŸƒ å¡ç‰Œä»“ä½ç®¡ç†</h2>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" name="position_management_enabled" id="pm-enabled" class="w-4 h-4">
                            <span class="text-sm font-medium text-gray-700">å¯ç”¨å¡ç‰Œç®¡ç†</span>
                        </label>
                    </div>

                    <div id="pm-config" style="display:none;" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    æ€»å¡ç‰Œæ•°é‡
                                </label>
                                <input type="number" name="total_cards" value="4" min="2" max="36"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <span class="text-xs text-gray-500">å»ºè®®4ä¸ªï¼Œæ”¯æŒ2-36ä¸ª</span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    å•å¡BNBæ•°é‡
                                </label>
                                <input type="number" name="per_card_max_bnb" value="0.25" step="0.01" min="0.01"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <span class="text-xs text-gray-500">æ¯ä¸ªå¡ç‰Œå¯¹åº”çš„æœ€å¤§BNB</span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    æœ€å°äº¤æ˜“å¡ç‰Œæ•°
                                </label>
                                <input type="number" name="min_cards_for_trade" value="1" min="1"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                åˆå§‹å¡ç‰Œåˆ†é…
                            </label>
                            <div class="initial-allocation">
                                <label class="flex items-center gap-2">
                                    <span>BNBå¡ç‰Œ:</span>
                                    <input type="number" name="initial_bnb_cards" value="4" min="0" max="36"
                                           class="w-20 px-3 py-1 border border-gray-300 rounded-md">
                                </label>
                                <label class="flex items-center gap-2">
                                    <span>ä»£å¸å¡ç‰Œ:</span>
                                    <input type="number" name="initial_token_cards" value="0" min="0" max="36"
                                           class="w-20 px-3 py-1 border border-gray-300 rounded-md">
                                </label>
                            </div>
                            <span class="text-xs text-gray-500">æ€»å¡ç‰Œæ•°å¿…é¡»ç­‰äº BNBå¡ç‰Œ + ä»£å¸å¡ç‰Œ</span>
                        </div>
                    </div>
                </div>

                <!-- ä¹°å…¥ç­–ç•¥é…ç½® -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">ğŸ“ˆ ä¹°å…¥ç­–ç•¥</h2>
                        <button type="button" onclick="addBuyStrategy()" class="btn-add">
                            <span>+ æ·»åŠ ä¹°å…¥æ¡ä»¶</span>
                        </button>
                    </div>
                    <div id="buy-strategies-container">
                        <!-- é»˜è®¤æ·»åŠ ä¸€ä¸ªæ—©æ­¢ä¹°å…¥ç­–ç•¥ -->
                    </div>
                </div>

                <!-- å–å‡ºç­–ç•¥é…ç½® -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">ğŸ“‰ å–å‡ºç­–ç•¥</h2>
                        <button type="button" onclick="addSellStrategy()" class="btn-add">
                            <span>+ æ·»åŠ å–å‡ºæ¡ä»¶</span>
                        </button>
                    </div>
                    <div id="sell-strategies-container">
                        <!-- é»˜è®¤æ·»åŠ æ­¢ç›ˆ1å’Œæ­¢ç›ˆ2ç­–ç•¥ -->
                    </div>
                </div>

                <!-- æ¡ä»¶è¡¨è¾¾å¼å¸®åŠ©å™¨ -->
                <div class="border border-blue-200 bg-blue-50 rounded-lg p-4">
                    <details>
                        <summary class="text-lg font-semibold text-blue-900 cursor-pointer">
                            ğŸ“– æ¡ä»¶è¡¨è¾¾å¼è¯­æ³•å¸®åŠ©ï¼ˆç‚¹å‡»å±•å¼€ï¼‰
                        </summary>
                        <div class="condition-help">
                            <h4>å¯ç”¨å› å­</h4>
                            <table class="help-table">
                                <tr>
                                    <th>å› å­</th>
                                    <th>ç±»å‹</th>
                                    <th>è¯´æ˜</th>
                                    <th>ç¤ºä¾‹</th>
                                </tr>
                                <tr>
                                    <td><code>age</code></td>
                                    <td>æ•°å­—</td>
                                    <td>ä»£å¸å¹´é¾„ï¼ˆåˆ†é’Ÿï¼‰</td>
                                    <td><code>age < 1.33</code></td>
                                </tr>
                                <tr>
                                    <td><code>earlyReturn</code></td>
                                    <td>æ•°å­—</td>
                                    <td>æ—©æœŸæ”¶ç›Šç‡ï¼ˆ%ï¼‰</td>
                                    <td><code>earlyReturn >= 80</code></td>
                                </tr>
                                <tr>
                                    <td><code>currentPrice</code></td>
                                    <td>æ•°å­—</td>
                                    <td>å½“å‰ä»·æ ¼</td>
                                    <td><code>currentPrice > 0</code></td>
                                </tr>
                                <tr>
                                    <td><code>collectionPrice</code></td>
                                    <td>æ•°å­—</td>
                                    <td>æ”¶é›†æ—¶çš„åŸºå‡†ä»·æ ¼</td>
                                    <td><code>currentPrice > collectionPrice</code></td>
                                </tr>
                                <tr>
                                    <td><code>highestPrice</code></td>
                                    <td>æ•°å­—</td>
                                    <td>å†å²æœ€é«˜ä»·æ ¼</td>
                                    <td><code>currentPrice > highestPrice * 0.9</code></td>
                                </tr>
                                <tr>
                                    <td><code>drawdownFromHighest</code></td>
                                    <td>æ•°å­—</td>
                                    <td>è·æœ€é«˜ä»·è·Œå¹…ï¼ˆ%ï¼‰</td>
                                    <td><code>drawdownFromHighest <= -20</code></td>
                                </tr>
                                <tr>
                                    <td><code>profitPercent</code></td>
                                    <td>æ•°å­—</td>
                                    <td>ç›ˆåˆ©ç™¾åˆ†æ¯”ï¼ˆ%ï¼‰</td>
                                    <td><code>profitPercent >= 30</code></td>
                                </tr>
                                <tr>
                                    <td><code>holdDuration</code></td>
                                    <td>æ•°å­—</td>
                                    <td>æŒä»“æ—¶é•¿ï¼ˆç§’ï¼‰</td>
                                    <td><code>holdDuration > 60</code></td>
                                </tr>
                            </table>

                            <h4>æ“ä½œç¬¦</h4>
                            <ul>
                                <li><code>AND</code> æˆ– <code>&&</code>: ä¸”æ¡ä»¶ï¼ˆä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³ï¼‰</li>
                                <li><code>OR</code> æˆ– <code>||</code>: æˆ–æ¡ä»¶ï¼ˆä»»ä¸€æ¡ä»¶æ»¡è¶³ï¼‰</li>
                                <li><code>> >= < <= == !=</code>: æ¯”è¾ƒè¿ç®—ç¬¦</li>
                            </ul>

                            <h4>é¢„è®¾ç­–ç•¥æ¨¡æ¿</h4>
                            <div class="preset-templates">
                                <button type="button" onclick="loadPreset('early_buy')">æ—©æ­¢ä¹°å…¥</button>
                                <button type="button" onclick="loadPreset('tp1')">æ­¢ç›ˆ1 (30%)</button>
                                <button type="button" onclick="loadPreset('tp2')">æ­¢ç›ˆ2 (50%)</button>
                                <button type="button" onclick="loadPreset('drawback_stop')">é«˜ä½å›è½æ­¢æŸ</button>
                                <button type="button" onclick="loadPreset('stop_loss')">æ—¶é—´æ­¢æŸ</button>
                            </div>
                        </div>
                    </details>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <div class="flex justify-end space-x-4">
                    <a href="/experiments" class="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-md font-medium">
                        å–æ¶ˆ
                    </a>
                    <button type="submit" id="submit-btn"
                            class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md font-medium">
                        åˆ›å»ºå®éªŒ
                    </button>
                </div>
            </form>
        </div>

        <!-- ç»“æœæ¶ˆæ¯ -->
        <div id="result-message" class="hidden mt-6">
            <div id="result-content" class="rounded-lg p-4"></div>
        </div>
    </div>

    <!-- ç­–ç•¥å¡ç‰‡æ¨¡æ¿ -->
    <template id="buy-strategy-template">
        <div class="strategy-card" data-action="buy" data-index="{INDEX}">
            <div class="card-header">
                <span class="strategy-name">ä¹°å…¥ç­–ç•¥ #{INDEX}</span>
                <button type="button" onclick="removeStrategy(this)" class="btn-remove">åˆ é™¤</button>
            </div>
            <div class="card-body">
                <div class="param-group" style="grid-column: 1 / span 2;">
                    <label>è§¦å‘æ¡ä»¶ï¼š</label>
                    <input type="text" name="buy_condition_{INDEX}"
                           placeholder="ä¾‹å¦‚: age < 1.33 AND earlyReturn >= 80 AND earlyReturn < 120"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="strategy-params">
                    <div class="param-group">
                        <label>å¡ç‰Œæ•°é‡</label>
                        <select name="buy_cards_{INDEX}">
                            <option value="1">1å¡</option>
                            <option value="2">2å¡</option>
                            <option value="3">3å¡</option>
                            <option value="4">4å¡</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <label>ä¼˜å…ˆçº§</label>
                        <input type="number" name="buy_priority_{INDEX}" value="1" min="1" max="100">
                    </div>
                    <div class="param-group">
                        <label>å†·å´(ç§’)</label>
                        <input type="number" name="buy_cooldown_{INDEX}" value="60" min="0">
                    </div>
                    <div class="param-group">
                        <label>æœ€å¤§æ‰§è¡Œæ¬¡æ•°</label>
                        <input type="number" name="buy_max_executions_{INDEX}" placeholder="ä¸é™" min="1">
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="sell-strategy-template">
        <div class="strategy-card" data-action="sell" data-index="{INDEX}">
            <div class="card-header">
                <span class="strategy-name">å–å‡ºç­–ç•¥ #{INDEX}</span>
                <button type="button" onclick="removeStrategy(this)" class="btn-remove">åˆ é™¤</button>
            </div>
            <div class="card-body">
                <div class="param-group" style="grid-column: 1 / span 2;">
                    <label>è§¦å‘æ¡ä»¶ï¼š</label>
                    <input type="text" name="sell_condition_{INDEX}"
                           placeholder="ä¾‹å¦‚: profitPercent >= 30 AND holdDuration > 0"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="strategy-params">
                    <div class="param-group">
                        <label>å¡ç‰Œæ•°é‡</label>
                        <select name="sell_cards_{INDEX}">
                            <option value="1">1å¡</option>
                            <option value="2">2å¡</option>
                            <option value="3">3å¡</option>
                            <option value="4">4å¡</option>
                            <option value="all" selected>å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <label>ä¼˜å…ˆçº§</label>
                        <input type="number" name="sell_priority_{INDEX}" value="1" min="1" max="100">
                    </div>
                    <div class="param-group">
                        <label>å†·å´(ç§’)</label>
                        <input type="number" name="sell_cooldown_{INDEX}" value="30" min="0">
                    </div>
                    <div class="param-group">
                        <label>æœ€å¤§æ‰§è¡Œæ¬¡æ•°</label>
                        <input type="number" name="sell_max_executions_{INDEX}" value="1" min="1">
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // å…¨å±€å˜é‡
        let buyStrategyCount = 0;
        let sellStrategyCount = 0;

        // DOM å…ƒç´ 
        const form = document.getElementById('experiment-form');
        const submitBtn = document.getElementById('submit-btn');
        const resultMessage = document.getElementById('result-message');
        const resultContent = document.getElementById('result-content');
        const pmEnabled = document.getElementById('pm-enabled');
        const pmConfig = document.getElementById('pm-config');
        const buyContainer = document.getElementById('buy-strategies-container');
        const sellContainer = document.getElementById('sell-strategies-container');
        const buyTemplate = document.getElementById('buy-strategy-template');
        const sellTemplate = document.getElementById('sell-strategy-template');

        // éªŒè¯æ¨¡æ¿å·²åŠ è½½
        if (!buyTemplate || !sellTemplate) {
            console.error('âŒ ç­–ç•¥æ¨¡æ¿æœªæ‰¾åˆ°ï¼');
        }

        // ğŸ”¥ æ£€æŸ¥æ˜¯å¦æ˜¯å¤åˆ¶æ¨¡å¼
        const urlParams = new URLSearchParams(window.location.search);
        const isCopyMode = urlParams.get('copy') === 'true';

        if (isCopyMode) {
            loadCopiedExperimentData();
        }

        // åŠ è½½å¤åˆ¶çš„å®éªŒæ•°æ®
        async function loadCopiedExperimentData() {
            try {
                const copyDataStr = sessionStorage.getItem('copyExperimentData');
                if (!copyDataStr) {
                    showCopyModeNotice('âŒ æœªæ‰¾åˆ°å¤åˆ¶çš„å®éªŒæ•°æ®');
                    return;
                }

                const copyData = JSON.parse(copyDataStr);
                console.log('ğŸ“‹ åŠ è½½å¤åˆ¶çš„å®éªŒæ•°æ®:', copyData);

                // å¡«å……åŸºæœ¬ä¿¡æ¯ï¼ˆå¸¦ç©ºå€¼æ£€æŸ¥ï¼‰
                const setFieldValue = (fieldName, value) => {
                    if (value === undefined || value === null) return;
                    const field = form.querySelector(`[name="${fieldName}"]`);
                    if (field) {
                        field.value = value;
                    } else {
                        console.warn(`âš ï¸ è¡¨å•å­—æ®µä¸å­˜åœ¨: ${fieldName}`);
                    }
                };

                setFieldValue('experiment_name', copyData.experiment_name);
                setFieldValue('experiment_description', copyData.experiment_description);
                setFieldValue('trading_mode', copyData.trading_mode);
                setFieldValue('blockchain', copyData.blockchain);
                // kline_type å­—æ®µåœ¨å½“å‰è¡¨å•ä¸­ä¸å­˜åœ¨ï¼Œè·³è¿‡
                // setFieldValue('kline_type', copyData.kline_type);

                // å¡«å……åˆå§‹ä½™é¢
                const initialBalance = copyData.initial_balance ||
                                     copyData.virtual?.initialBalance ||
                                     copyData.virtual?.initial_balance ||
                                     copyData.backtest?.initial_balance ||
                                     100;
                setFieldValue('initial_balance', initialBalance);

                // å¡«å……ä»“ä½ç®¡ç†é…ç½®
                if (copyData.positionManagement) {
                    const pm = copyData.positionManagement;
                    pmEnabled.checked = pm.enabled === true;
                    pmConfig.style.display = pm.enabled ? 'block' : 'none';

                    setFieldValue('total_cards', pm.totalCards);
                    setFieldValue('per_card_max_bnb', pm.perCardMaxBNB);
                    setFieldValue('min_cards_for_trade', pm.minCardsForTrade);
                    if (pm.initialAllocation) {
                        setFieldValue('initial_bnb_cards', pm.initialAllocation.bnbCards || 4);
                        setFieldValue('initial_token_cards', pm.initialAllocation.tokenCards || 0);
                    }
                }

                // å¡«å……ç­–ç•¥é…ç½®
                // æ¸…é™¤é»˜è®¤é¢„è®¾ç­–ç•¥
                buyContainer.innerHTML = '';
                sellContainer.innerHTML = '';
                buyStrategyCount = 0;
                sellStrategyCount = 0;

                console.log('ğŸ“‹ å¼€å§‹å¤„ç†ç­–ç•¥é…ç½®...');
                console.log('  buyStrategies:', copyData.buyStrategies);
                console.log('  sellStrategies:', copyData.sellStrategies);

                // æ–°æ ¼å¼ï¼šåˆ†ç¦»çš„ buyStrategies å’Œ sellStrategies
                if (copyData.buyStrategies && Array.isArray(copyData.buyStrategies)) {
                    console.log(`âœ… æ‰¾åˆ° ${copyData.buyStrategies.length} ä¸ªä¹°å…¥ç­–ç•¥`);
                    copyData.buyStrategies.forEach((strategy, idx) => {
                        console.log(`  æ·»åŠ ä¹°å…¥ç­–ç•¥ #${idx + 1}:`, strategy);
                        addBuyStrategy({
                            condition: strategy.condition,
                            cards: strategy.cards,
                            priority: strategy.priority,
                            cooldown: strategy.cooldown,
                            maxExecutions: strategy.maxExecutions,
                            description: strategy.description
                        });
                    });
                } else {
                    console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ° buyStrategies æˆ–ä¸æ˜¯æ•°ç»„');
                }

                if (copyData.sellStrategies && Array.isArray(copyData.sellStrategies)) {
                    console.log(`âœ… æ‰¾åˆ° ${copyData.sellStrategies.length} ä¸ªå–å‡ºç­–ç•¥`);
                    copyData.sellStrategies.forEach((strategy, idx) => {
                        console.log(`  æ·»åŠ å–å‡ºç­–ç•¥ #${idx + 1}:`, strategy);
                        addSellStrategy({
                            condition: strategy.condition,
                            cards: strategy.cards,
                            priority: strategy.priority,
                            cooldown: strategy.cooldown,
                            maxExecutions: strategy.maxExecutions,
                            description: strategy.description
                        });
                    });
                } else {
                    console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ° sellStrategies æˆ–ä¸æ˜¯æ•°ç»„');
                }

                // å…¼å®¹æ—§æ ¼å¼ï¼šstrategies æ•°ç»„ï¼ˆå¸¦ action å­—æ®µï¼‰
                if (copyData.strategies && Array.isArray(copyData.strategies) && !copyData.buyStrategies) {
                    copyData.strategies.forEach(strategy => {
                        if (strategy.action === 'buy') {
                            addBuyStrategy({
                                condition: strategy.condition,
                                cards: strategy.cards,
                                priority: strategy.priority,
                                cooldown: strategy.cooldown,
                                maxExecutions: strategy.maxExecutions
                            });
                        } else if (strategy.action === 'sell') {
                            addSellStrategy({
                                condition: strategy.condition,
                                cards: strategy.cards,
                                priority: strategy.priority,
                                cooldown: strategy.cooldown,
                                maxExecutions: strategy.maxExecutions
                            });
                        }
                    });
                }

                // æ˜¾ç¤ºå¤åˆ¶æ¨¡å¼é€šçŸ¥
                showCopyModeNotice('âœ… å·²åŠ è½½å¤åˆ¶çš„å®éªŒé…ç½®ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹ååˆ›å»ºæ–°å®éªŒ');

                // æ¸…é™¤sessionStorage
                sessionStorage.removeItem('copyExperimentData');

            } catch (error) {
                console.error('âŒ åŠ è½½å¤åˆ¶æ•°æ®å¤±è´¥:', error);
                showCopyModeNotice('âŒ åŠ è½½å¤åˆ¶æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºå¤åˆ¶æ¨¡å¼é€šçŸ¥
        function showCopyModeNotice(message) {
            const notice = document.createElement('div');
            notice.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-2';
            notice.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="text-indigo-200 hover:text-white">
                    âœ•
                </button>
            `;
            document.body.appendChild(notice);

            // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notice.style.opacity = '0';
                notice.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    if (notice.parentElement) {
                        notice.parentElement.removeChild(notice);
                    }
                }, 300);
            }, 5000);
        }

        // å¡ç‰Œç®¡ç†å¯ç”¨/ç¦ç”¨
        pmEnabled.addEventListener('change', () => {
            pmConfig.style.display = pmEnabled.checked ? 'block' : 'none';
        });

        // æ·»åŠ ä¹°å…¥ç­–ç•¥
        function addBuyStrategy(config = {}) {
            console.log('addBuyStrategy è¢«è°ƒç”¨ï¼Œconfig:', config);
            console.log('buyTemplate:', buyTemplate);
            console.log('buyContainer:', buyContainer);

            const index = buyStrategyCount++;
            let html = buyTemplate.innerHTML.replace(/\{INDEX\}/g, index);
            console.log('æ¨¡æ¿HTMLé•¿åº¦:', html.length);

            // åº”ç”¨é¢„è®¾é…ç½®
            if (config.condition) {
                html = html.replace(`name="buy_condition_${index}"`, `name="buy_condition_${index}" value="${config.condition}"`);
            }
            if (config.cards !== undefined) {
                html = html.replace(`name="buy_cards_${index}"`, `name="buy_cards_${index}"`);
                // æ‰¾åˆ°selectå¹¶è®¾ç½®selectedå±æ€§
                const temp = document.createElement('div');
                temp.innerHTML = html;
                const select = temp.querySelector(`select[name="buy_cards_${index}"]`);
                if (select) {
                    // è®¾ç½®selectçš„å€¼
                    select.value = String(config.cards);
                    // æ‰‹åŠ¨è®¾ç½®å¯¹åº”optionçš„selectedå±æ€§
                    const options = select.querySelectorAll('option');
                    options.forEach(opt => {
                        if (opt.value === String(config.cards)) {
                            opt.setAttribute('selected', 'selected');
                        } else {
                            opt.removeAttribute('selected');
                        }
                    });
                }
                html = temp.innerHTML;
            }
            if (config.priority) {
                html = html.replace(`name="buy_priority_${index}" value="1"`, `name="buy_priority_${index}" value="${config.priority}"`);
            }
            if (config.cooldown) {
                html = html.replace(`name="buy_cooldown_${index}" value="60"`, `name="buy_cooldown_${index}" value="${config.cooldown}"`);
            }
            if (config.maxExecutions !== undefined) {
                const attr = config.maxExecutions ? `value="${config.maxExecutions}"` : 'placeholder="ä¸é™"';
                html = html.replace(`name="buy_max_executions_${index}" placeholder`, `name="buy_max_executions_${index}" ${attr}`);
            }

            buyContainer.insertAdjacentHTML('beforeend', html);
        }

        // æ·»åŠ å–å‡ºç­–ç•¥
        function addSellStrategy(config = {}) {
            const index = sellStrategyCount++;
            let html = sellTemplate.innerHTML.replace(/\{INDEX\}/g, index);

            // åº”ç”¨é¢„è®¾é…ç½®
            if (config.condition) {
                html = html.replace(`name="sell_condition_${index}"`, `name="sell_condition_${index}" value="${config.condition}"`);
            }
            if (config.cards !== undefined) {
                html = html.replace(`name="sell_cards_${index}"`, `name="sell_cards_${index}"`);
                // æ‰¾åˆ°selectå¹¶è®¾ç½®selectedå±æ€§
                const temp = document.createElement('div');
                temp.innerHTML = html;
                const select = temp.querySelector(`select[name="sell_cards_${index}"]`);
                if (select) {
                    // è®¾ç½®selectçš„å€¼
                    select.value = String(config.cards);
                    // æ‰‹åŠ¨è®¾ç½®å¯¹åº”optionçš„selectedå±æ€§
                    const options = select.querySelectorAll('option');
                    options.forEach(opt => {
                        if (opt.value === String(config.cards)) {
                            opt.setAttribute('selected', 'selected');
                        } else {
                            opt.removeAttribute('selected');
                        }
                    });
                }
                html = temp.innerHTML;
            }
            if (config.priority) {
                html = html.replace(`name="sell_priority_${index}" value="1"`, `name="sell_priority_${index}" value="${config.priority}"`);
            }
            if (config.cooldown) {
                html = html.replace(`name="sell_cooldown_${index}" value="30"`, `name="sell_cooldown_${index}" value="${config.cooldown}"`);
            }
            if (config.maxExecutions !== undefined) {
                const attr = config.maxExecutions ? `value="${config.maxExecutions}"` : 'placeholder="ä¸é™"';
                html = html.replace(`name="sell_max_executions_${index}" value="1"`, `name="sell_max_executions_${index}" ${attr}`);
            }

            sellContainer.insertAdjacentHTML('beforeend', html);
        }

        // åˆ é™¤ç­–ç•¥
        function removeStrategy(button) {
            const card = button.closest('.strategy-card');
            const action = card.dataset.action;
            const index = parseInt(card.dataset.index);

            card.remove();

            // é‡æ–°ç¼–å·
            const container = action === 'buy' ? buyContainer : sellContainer;
            container.querySelectorAll('.strategy-card').forEach((c, i) => {
                c.dataset.index = i;
                c.querySelector('.strategy-name').textContent =
                    (action === 'buy' ? 'ä¹°å…¥ç­–ç•¥' : 'å–å‡ºç­–ç•¥') + ' #' + (i + 1);

                // æ›´æ–°æ‰€æœ‰nameå±æ€§ä¸­çš„ç´¢å¼•
                c.querySelectorAll('[name]').forEach(input => {
                    input.name = input.name.replace(/\d+$/, i);
                });
            });

            // æ›´æ–°è®¡æ•°å™¨
            if (action === 'buy') {
                buyStrategyCount = container.querySelectorAll('.strategy-card').length;
            } else {
                sellStrategyCount = container.querySelectorAll('.strategy-card').length;
            }
        }

        // åŠ è½½é¢„è®¾æ¨¡æ¿
        function loadPreset(preset) {
            const presets = {
                early_buy: {
                    action: 'buy',
                    condition: 'age < 1.33 AND earlyReturn >= 80 AND earlyReturn < 120 AND currentPrice > 0',
                    cards: 1,
                    priority: 1,
                    cooldown: 60,
                    maxExecutions: null
                },
                tp1: {
                    action: 'sell',
                    condition: 'profitPercent >= 30 AND holdDuration > 0',
                    cards: 1,
                    priority: 1,
                    cooldown: 30,
                    maxExecutions: 1
                },
                tp2: {
                    action: 'sell',
                    condition: 'profitPercent >= 50 AND holdDuration > 0',
                    cards: 'all',
                    priority: 2,
                    cooldown: 30,
                    maxExecutions: 1
                },
                drawback_stop: {
                    action: 'sell',
                    condition: 'profitPercent >= 20 AND drawdownFromHighest <= -30',
                    cards: 'all',
                    priority: 5,
                    cooldown: 60,
                    maxExecutions: 1,
                    description: 'ç›ˆåˆ©20%åï¼Œä»æœ€é«˜ç‚¹å›è½30%æ—¶æ­¢æŸ'
                },
                stop_loss: {
                    action: 'sell',
                    condition: 'holdDuration >= 300 AND profitPercent <= 0',
                    cards: 'all',
                    priority: 10,
                    cooldown: 60,
                    maxExecutions: 1
                }
            };

            const config = presets[preset];
            if (config) {
                if (config.action === 'buy') {
                    addBuyStrategy(config);
                } else {
                    addSellStrategy(config);
                }
            }
        }

        // æ”¶é›†è¡¨å•æ•°æ®
        function collectFormData() {
            const formData = new FormData(form);

            // æ”¶é›†ä¹°å…¥ç­–ç•¥
            const buyStrategies = [];
            document.querySelectorAll('#buy-strategies-container .strategy-card').forEach(card => {
                const index = card.dataset.index;
                const maxExecutionsInput = card.querySelector(`input[name="buy_max_executions_${index}"]`);
                buyStrategies.push({
                    condition: card.querySelector(`input[name="buy_condition_${index}"]`).value,
                    cards: card.querySelector(`select[name="buy_cards_${index}"]`).value,
                    priority: parseInt(card.querySelector(`input[name="buy_priority_${index}"]`).value),
                    cooldown: parseInt(card.querySelector(`input[name="buy_cooldown_${index}"]`).value),
                    maxExecutions: maxExecutionsInput.value ? parseInt(maxExecutionsInput.value) : null
                });
            });

            // æ”¶é›†å–å‡ºç­–ç•¥
            const sellStrategies = [];
            document.querySelectorAll('#sell-strategies-container .strategy-card').forEach(card => {
                const index = card.dataset.index;
                const maxExecutionsInput = card.querySelector(`input[name="sell_max_executions_${index}"]`);
                sellStrategies.push({
                    condition: card.querySelector(`input[name="sell_condition_${index}"]`).value,
                    cards: card.querySelector(`select[name="sell_cards_${index}"]`).value,
                    priority: parseInt(card.querySelector(`input[name="sell_priority_${index}"]`).value),
                    cooldown: parseInt(card.querySelector(`input[name="sell_cooldown_${index}"]`).value),
                    maxExecutions: maxExecutionsInput.value ? parseInt(maxExecutionsInput.value) : null
                });
            });

            // æ„å»ºé…ç½®æ•°æ®
            return {
                experiment_name: formData.get('experiment_name'),
                experiment_description: formData.get('experiment_description'),
                trading_mode: formData.get('trading_mode'),
                blockchain: formData.get('blockchain'),
                initial_balance: parseFloat(formData.get('initial_balance')),
                // ç­–ç•¥é…ç½®
                strategy: {
                    buyStrategies: buyStrategies,
                    sellStrategies: sellStrategies,
                    // å¡ç‰Œç®¡ç†é…ç½®
                    positionManagement: pmEnabled.checked ? {
                        enabled: true,
                        totalCards: parseInt(formData.get('total_cards')) || 4,
                        perCardMaxBNB: parseFloat(formData.get('per_card_max_bnb')) || 0.025,
                        minCardsForTrade: parseInt(formData.get('min_cards_for_trade')) || 1,
                        initialAllocation: {
                            bnbCards: parseInt(formData.get('initial_bnb_cards')) || 4,
                            tokenCards: parseInt(formData.get('initial_token_cards')) || 0
                        }
                    } : null
                },
                // è™šæ‹Ÿäº¤æ˜“é…ç½®
                virtual: {
                    initialBalance: parseFloat(formData.get('initial_balance')),
                    tradeAmount: null  // å°†ç”±å¡ç‰Œç®¡ç†å™¨è®¡ç®—
                }
            };
        }

        // è¡¨å•æäº¤
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // éªŒè¯
            const buyStrategies = document.querySelectorAll('#buy-strategies-container .strategy-card');
            const sellStrategies = document.querySelectorAll('#sell-strategies-container .strategy-card');

            if (buyStrategies.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªä¹°å…¥ç­–ç•¥');
                return;
            }
            if (sellStrategies.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå–å‡ºç­–ç•¥');
                return;
            }

            // ç¦ç”¨æäº¤æŒ‰é’®
            submitBtn.disabled = true;
            submitBtn.textContent = 'åˆ›å»ºä¸­...';

            const data = collectFormData();

            try {
                const response = await fetch('/api/experiments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    resultMessage.classList.remove('hidden');
                    resultContent.className = 'bg-green-50 border border-green-200 text-green-800 rounded-lg p-4';
                    resultContent.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-semibold">âœ… å®éªŒåˆ›å»ºæˆåŠŸï¼</p>
                                <p class="text-sm mt-1">å®éªŒID: ${result.data.id}</p>
                                <p class="text-sm mt-1">å®éªŒåç§°: ${result.data.experiment_name}</p>
                            </div>
                            <a href="/experiments" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm">
                                è¿”å›åˆ—è¡¨
                            </a>
                        </div>
                    `;

                    // 3ç§’åè‡ªåŠ¨è·³è½¬
                    setTimeout(() => {
                        window.location.href = '/experiments';
                    }, 3000);
                } else {
                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    resultMessage.classList.remove('hidden');
                    resultContent.className = 'bg-red-50 border border-red-200 text-red-800 rounded-lg p-4';
                    resultContent.innerHTML = `
                        <p class="font-semibold">âŒ åˆ›å»ºå¤±è´¥</p>
                        <p class="text-sm mt-1">${result.error || 'æœªçŸ¥é”™è¯¯'}</p>
                    `;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'åˆ›å»ºå®éªŒ';
                }
            } catch (error) {
                // æ˜¾ç¤ºç½‘ç»œé”™è¯¯
                resultMessage.classList.remove('hidden');
                resultContent.className = 'bg-red-50 border border-red-200 text-red-800 rounded-lg p-4';
                resultContent.innerHTML = `
                    <p class="font-semibold">âŒ ç½‘ç»œé”™è¯¯</p>
                    <p class="text-sm mt-1">${error.message}</p>
                `;
                submitBtn.disabled = false;
                submitBtn.textContent = 'åˆ›å»ºå®éªŒ';
            }
        });

        // åˆå§‹åŒ–é»˜è®¤ç­–ç•¥
        loadPreset('early_buy');
        loadPreset('tp1');
        loadPreset('tp2');
    </script>
</body>
</html>
