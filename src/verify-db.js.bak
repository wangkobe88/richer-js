#!/usr/bin/env node

require('dotenv').config({ path: '../config/.env' });
const { dbManager } = require('./src/services/dbManager');

async function verifyDatabase() {
  const supabase = dbManager.getClient();

  console.log('');
  console.log('========================================');
  console.log('ğŸ” éªŒè¯æ•°æ®åº“æ•°æ®');
  console.log('========================================');
  console.log('');

  // æŸ¥è¯¢å®éªŒ
  console.log('ğŸ“Š æŸ¥è¯¢å®éªŒåˆ—è¡¨...');
  const { data: experiments, error: expError } = await supabase
    .from('experiments')
    .select('*')
    .order('created_at', { ascending: false })
    .limit(5);

  if (expError) {
    console.error('âŒ æŸ¥è¯¢å®éªŒå¤±è´¥:', expError);
  } else {
    console.log(`âœ… æ‰¾åˆ° ${experiments.length} ä¸ªå®éªŒ:`);
    experiments.forEach(exp => {
      console.log(`   - ${exp.experiment_name} (${exp.id})`);
      console.log(`     çŠ¶æ€: ${exp.status}, æ¨¡å¼: ${exp.trading_mode}`);
    });
  }
  console.log('');

  // æŸ¥è¯¢ä¿¡å·
  console.log('ğŸ“ˆ æŸ¥è¯¢ä¿¡å·è®°å½•...');
  const { data: signals, error: sigError } = await supabase
    .from('strategy_signals')
    .select('*')
    .order('created_at', { ascending: false })
    .limit(5);

  if (sigError) {
    console.error('âŒ æŸ¥è¯¢ä¿¡å·å¤±è´¥:', sigError);
  } else {
    console.log(`âœ… æ‰¾åˆ° ${signals.length} æ¡ä¿¡å·:`);
    signals.forEach(sig => {
      console.log(`   - ${sig.signal_type} ${sig.token_symbol} @ ${sig.createdAt}`);
      console.log(`     åŸå› : ${sig.reason}`);
    });
  }
  console.log('');

  // æŸ¥è¯¢äº¤æ˜“
  console.log('ğŸ’° æŸ¥è¯¢äº¤æ˜“è®°å½•...');
  const { data: trades, error: tradeError } = await supabase
    .from('trades')
    .select('*')
    .order('created_at', { ascending: false })
    .limit(5);

  if (tradeError) {
    console.error('âŒ æŸ¥è¯¢äº¤æ˜“å¤±è´¥:', tradeError);
  } else {
    console.log(`âœ… æ‰¾åˆ° ${trades.length} æ¡äº¤æ˜“:`);
    trades.forEach(trade => {
      console.log(`   - ${trade.direction} ${trade.token_symbol} ${trade.amount} @ ${trade.price}`);
      console.log(`     çŠ¶æ€: ${trade.status}, æˆåŠŸ: ${trade.success}`);
    });
  }
  console.log('');

  // æŸ¥è¯¢æŒ‡æ ‡
  console.log('ğŸ“Š æŸ¥è¯¢è¿è¡Œæ—¶æŒ‡æ ‡...');
  const { data: metrics, error: metricError } = await supabase
    .from('runtime_metrics')
    .select('*')
    .order('recorded_at', { ascending: false })
    .limit(5);

  if (metricError) {
    console.error('âŒ æŸ¥è¯¢æŒ‡æ ‡å¤±è´¥:', metricError);
  } else {
    console.log(`âœ… æ‰¾åˆ° ${metrics.length} æ¡æŒ‡æ ‡:`);
    metrics.forEach(met => {
      console.log(`   - ${met.metric_name}: ${met.metric_value}`);
    });
  }
  console.log('');

  console.log('========================================');
  console.log('âœ… æ•°æ®åº“éªŒè¯å®Œæˆï¼');
  console.log('========================================');
  console.log('');
}

verifyDatabase().catch(console.error);
