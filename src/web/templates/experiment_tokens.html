<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实验代币 - Richer-js Fourmeme Trading</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="/static/css/light-theme.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="/static/css/main.css" rel="stylesheet">
    <style>
        .status-monitoring { background-color: #fef3c7; color: #92400e; }
        .status-bought { background-color: #d1fae5; color: #065f46; }
        .status-exited { background-color: #e5e7eb; color: #374151; }
        .status-failed { background-color: #fee2e2; color: #991b1b; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .timeline {
            position: relative;
            padding-left: 20px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }
        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 4px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-7xl">
        <!-- 页头 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">实验代币</h1>
                    <p class="text-gray-600 mt-1" id="experiment-name">加载中...</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md">
                        刷新
                    </button>
                    <a href="/experiments" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md">
                        返回列表
                    </a>
                </div>
            </div>
        </div>

        <!-- 统计概览 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6" id="stats-container">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">统计概览</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold text-gray-800" id="stat-total">-</div>
                    <div class="text-sm text-gray-600">处理过</div>
                </div>
                <div class="text-center p-4 bg-yellow-50 rounded-lg">
                    <div class="text-2xl font-bold text-yellow-600" id="stat-monitoring">-</div>
                    <div class="text-sm text-gray-600">监控中</div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-2xl font-bold text-green-600" id="stat-bought">-</div>
                    <div class="text-sm text-gray-600">已买入</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold text-gray-600" id="stat-exited">-</div>
                    <div class="text-sm text-gray-600">已退出</div>
                </div>
            </div>
            <div class="mt-4 text-sm text-gray-500">
                买入率: <span id="stat-buy-rate">-</span>
            </div>
        </div>

        <!-- 筛选和搜索 -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex flex-wrap gap-4 items-center">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">状态</label>
                    <select id="filter-status" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">全部</option>
                        <option value="monitoring">监控中</option>
                        <option value="bought">已买入</option>
                        <option value="exited">已退出</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">搜索</label>
                    <input type="text" id="search-input" placeholder="代币符号或地址..."
                           class="px-3 py-2 border border-gray-300 rounded-md w-48">
                </div>
            </div>
        </div>

        <!-- 代币列表 -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">代币</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">状态</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">发现时间</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">交易次数</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">操作</th>
                    </tr>
                </thead>
                <tbody id="tokens-table">
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex justify-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-2"></div>
                                加载中...
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        <div class="bg-white rounded-lg shadow-md p-4 mt-6">
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    显示 <span id="showing-from">0</span> - <span id="showing-to">0</span> / 共 <span id="total-count">0</span>
                </div>
                <div class="flex gap-2">
                    <button id="prev-btn" onclick="prevPage()" disabled
                            class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-md disabled:opacity-50">
                        上一页
                    </button>
                    <button id="next-btn" onclick="nextPage()" disabled
                            class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-md disabled:opacity-50">
                        下一页
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 代币详情弹窗 -->
    <div id="token-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800" id="modal-token-symbol">代币详情</h2>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div id="modal-content"></div>
                <div class="mt-6 text-right">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const experimentId = new URLSearchParams(window.location.search).get('id');
        let currentPage = 1;
        const pageSize = 20;
        let totalTokens = 0;
        let currentData = [];
        let allTokens = [];

        // 状态映射
        const statusMap = {
            'monitoring': { text: '监控中', class: 'status-monitoring' },
            'bought': { text: '已买入', class: 'status-bought' },
            'exited': { text: '已退出', class: 'status-exited' },
            'failed': { text: '失败', class: 'status-failed' }
        };

        // 加载实验信息
        async function loadExperimentInfo() {
            try {
                const res = await fetch(`/api/experiment/${experimentId}`);
                const result = await res.json();
                if (result.success) {
                    document.getElementById('experiment-name').textContent = result.data.experimentName;
                }
            } catch (error) {
                console.error('加载实验信息失败:', error);
            }
        }

        // 加载代币数据
        async function loadData() {
            showLoading();

            try {
                const status = document.getElementById('filter-status').value;
                const search = document.getElementById('search-input').value;

                // 加载代币
                const res = await fetch(`/api/experiment/${experimentId}/tokens?status=${status}&limit=1000`);
                const result = await res.json();

                if (result.success) {
                    allTokens = result.tokens || [];
                    totalTokens = result.tokens.length;

                    // 本地筛选
                    if (search) {
                        const searchLower = search.toLowerCase();
                        allTokens = allTokens.filter(t =>
                            (t.token_symbol && t.token_symbol.toLowerCase().includes(searchLower)) ||
                            (t.token_address && t.token_address.toLowerCase().includes(searchLower))
                        );
                    }

                    updateDisplay();
                } else {
                    showError(result.error || '加载数据失败');
                }
            } catch (error) {
                showError('网络错误: ' + error.message);
            }
        }

        // 更新显示
        function updateDisplay() {
            updateStats();
            updateTable();
            updatePagination();
        }

        // 更新统计
        function updateStats() {
            const stats = {
                total: allTokens.length,
                monitoring: allTokens.filter(t => t.status === 'monitoring').length,
                bought: allTokens.filter(t => t.status === 'bought').length,
                exited: allTokens.filter(t => t.status === 'exited').length
            };

            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-monitoring').textContent = stats.monitoring;
            document.getElementById('stat-bought').textContent = stats.bought;
            document.getElementById('stat-exited').textContent = stats.exited;
            document.getElementById('stat-buy-rate').textContent = stats.total > 0
                ? (stats.bought / stats.total * 100).toFixed(1) + '%'
                : '0%';
        }

        // 更新表格
        function updateTable() {
            const tbody = document.getElementById('tokens-table');
            const start = (currentPage - 1) * pageSize;
            const end = Math.min(start + pageSize, allTokens.length);
            currentData = allTokens.slice(start, end);

            if (currentData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            暂无数据
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = currentData.map(token => {
                const status = statusMap[token.status] || { text: token.status, class: '' };
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">${token.token_symbol || '-'}</div>
                            <div class="text-xs text-gray-500 font-mono">${token.token_address?.substring(0, 10)}...</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded text-xs ${status.class}">${status.text}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            ${formatDateTime(token.discovered_at)}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            ${token.trade_count || 0}
                        </td>
                        <td class="px-4 py-3">
                            <button onclick="showTokenDetail('${token.token_address}')"
                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                详情
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 更新分页
        function updatePagination() {
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, totalTokens);

            document.getElementById('showing-from').textContent = start;
            document.getElementById('showing-to').textContent = end;
            document.getElementById('total-count').textContent = totalTokens;

            document.getElementById('prev-btn').disabled = currentPage <= 1;
            document.getElementById('next-btn').disabled = end >= totalTokens;
        }

        // 分页操作
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
                updatePagination();
            }
        }

        function nextPage() {
            if (currentPage * pageSize < totalTokens) {
                currentPage++;
                updateTable();
                updatePagination();
            }
        }

        // 显示代币详情
        async function showTokenDetail(tokenAddress) {
            try {
                // 获取代币基本信息
                const res = await fetch(`/api/experiment/${experimentId}/tokens/${tokenAddress}`);
                const result = await res.json();

                if (!result.success) {
                    alert('加载代币详情失败');
                    return;
                }

                const token = result.data;

                // 获取关联的交易记录
                const tradesRes = await fetch(`/api/experiment/${experimentId}/trades?limit=20`);
                const tradesResult = await tradesRes.json();
                const trades = tradesResult.success ? (tradesResult.trades || []) : [];

                // 获取关联的信号记录
                const signalsRes = await fetch(`/api/experiment/${experimentId}/signals?limit=10`);
                const signalsResult = await signalsRes.json();
                const signals = signalsResult.success ? (signalsResult.signals || []) : [];

                // 构建详情内容
                document.getElementById('modal-token-symbol').textContent = token.token_symbol || '代币详情';
                document.getElementById('modal-content').innerHTML = `
                    <div class="space-y-4">
                        <!-- 基本信息 -->
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">基本信息</h3>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div><span class="text-gray-500">地址:</span></div>
                                <div class="font-mono text-xs break-all">${token.token_address}</div>
                                <div><span class="text-gray-500">状态:</span></div>
                                <div><span class="px-2 py-1 rounded text-xs ${statusMap[token.status]?.class || ''}">${statusMap[token.status]?.text || token.status}</span></div>
                                <div><span class="text-gray-500">区块链:</span></div>
                                <div>${token.blockchain?.toUpperCase() || '-'}</div>
                                <div><span class="text-gray-500">发现时间:</span></div>
                                <div>${formatDateTime(token.discovered_at)}</div>
                            </div>
                        </div>

                        <!-- 交易历史 -->
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">交易历史 (${trades.length})</h3>
                            ${trades.length > 0 ? `
                                <div class="space-y-2">
                                    ${trades.map(trade => `
                                        <div class="text-sm p-2 bg-gray-50 rounded">
                                            <div class="flex justify-between">
                                                <span>${trade.direction === 'buy' ? '买入' : '卖出'}</span>
                                                <span class="text-gray-500">${formatDateTime(trade.created_at)}</span>
                                            </div>
                                            <div>数量: ${trade.amount?.toFixed(4) || '-'}</div>
                                            <div>价格: $${trade.price?.toFixed(12) || '-'}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p class="text-gray-500 text-sm">暂无交易记录</p>'}
                        </div>

                        <!-- 信号历史 -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">信号历史 (${signals.length})</h3>
                            ${signals.length > 0 ? `
                                <div class="space-y-2">
                                    ${signals.slice(0, 5).map(signal => `
                                        <div class="text-sm p-2 bg-blue-50 rounded">
                                            <div class="flex justify-between">
                                                <span>${signal.signalType || signal.action}</span>
                                                <span class="text-gray-500">${formatDateTime(signal.created_at)}</span>
                                            </div>
                                            <div>${signal.reason || signal.metadata?.reason || '-'}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p class="text-gray-500 text-sm">暂无信号记录</p>'}
                        </div>
                    </div>
                `;

                // 显示弹窗
                document.getElementById('token-modal').classList.add('active');

            } catch (error) {
                console.error('加载代币详情失败:', error);
                alert('加载失败: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('token-modal').classList.remove('active');
        }

        // 工具函数
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showLoading() {
            document.getElementById('tokens-table').innerHTML = `
                <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex justify-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-2"></div>
                            加载中...
                        </div>
                    </td>
                </tr>
            `;
        }

        function showError(message) {
            document.getElementById('tokens-table').innerHTML = `
                <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-red-500">
                        ${message}
                    </td>
                </tr>
            `;
        }

        // 事件监听
        document.getElementById('filter-status').addEventListener('change', loadData);
        document.getElementById('search-input').addEventListener('input', debounce(loadData, 500));

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 初始化
        loadExperimentInfo();
        loadData();
    </script>
</body>
</html>
